@* Views/Hierarchy/_OrgChartNode.cshtml *@
@model ERMS.ViewModels.Hierarchy.OrgChartNodeViewModel
@{
    var node  = Model.Node;
    var depth = Model.Depth;

    string[] avatarPalette = { "#0181b0","#10b981","#f59e0b","#8b5cf6","#06b6d4","#ef4444","#ec4899","#6366f1" };

    string AvatarBg(string name) {
        int ci = 0; foreach (char c in (name ?? "")) ci += c;
        return avatarPalette[ci % avatarPalette.Length];
    }
    string Initials(string name) {
        var p = (name ?? "?").Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return p.Length >= 2
            ? $"{char.ToUpper(p[0][0])}{char.ToUpper(p[^1][0])}"
            : (name?.Length > 0 ? char.ToUpper(name[0]).ToString() : "?");
    }

    var avatarBg = AvatarBg(node.Name);
    var initials = Initials(node.Name);
    var hasKids  = node.Children != null && node.Children.Any();
    var hasPhoto = !string.IsNullOrWhiteSpace(node.ImageUrl);
    var photoSrc = hasPhoto ? Url.Content(node.ImageUrl) : null;
    var isRoot   = depth == 0;
}

<div class="oc2-node @(isRoot ? "oc2-root" : "") @(hasKids ? "oc2-has-children" : "")">
    <a class="oc2-card" href="/Hierarchy/Employee/@node.Id">

        @* Depth indicator stripe *@
        <div class="oc2-card-stripe" style="--stripe-color: @avatarBg"></div>

        <div class="oc2-card-inner">

            @* Avatar *@
            @if (hasPhoto)
            {
                <div class="oc2-avatar oc2-avatar-photo" style="--av-bg: @avatarBg">
                    <img src="@photoSrc"
                         alt="@node.Name"
                         class="oc2-avatar-img"
                         onerror="var av=this.closest('.oc2-avatar'); av.classList.remove('oc2-avatar-photo'); av.style.background=av.style.getPropertyValue('--av-bg'); av.innerHTML='@initials'; this.remove();" />
                </div>
            }
            else
            {
                <div class="oc2-avatar" style="background: @avatarBg">@initials</div>
            }

            @* Info *@
            <div class="oc2-card-info">
                <span class="oc2-card-name">@node.Name</span>
                @if (!string.IsNullOrWhiteSpace(node.Title))
                {
                    <span class="oc2-card-title">@node.Title</span>
                }
                @if (!string.IsNullOrWhiteSpace(node.Department))
                {
                    <span class="oc2-card-dept">
                        <i class="fas fa-building"></i>
                        @node.Department
                    </span>
                }
            </div>

        </div>

        @* Footer: direct reports count *@
        @if (hasKids)
        {
            <div class="oc2-card-footer">
                <i class="fas fa-sitemap"></i>
                @node.Children!.Count @(node.Children!.Count == 1 ? "report" : "reports")
            </div>
        }

    </a>

    @* Children *@
    @if (hasKids)
    {
        <div class="oc2-children">
            @foreach (var child in node.Children!)
            {
                @await Html.PartialAsync("_OrgChartNode", new ERMS.ViewModels.Hierarchy.OrgChartNodeViewModel {
                    Node  = child,
                    Depth = depth + 1
                })
            }
        </div>
    }
</div>
