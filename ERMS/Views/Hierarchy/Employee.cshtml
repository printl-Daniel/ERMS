@* Views/Hierarchy/Employee.cshtml *@
@model ERMS.ViewModels.Hierarchy.EmployeeHierarchyViewModel

@{
    ViewData["Title"] = $"{Model.Employee.FullName} - Hierarchy";

    string[] palette = { "#0181b0","#10b981","#f59e0b","#8b5cf6","#06b6d4","#ef4444","#ec4899","#6366f1" };

    string AvatarBg(string name) {
        int ci = 0; foreach (char c in (name ?? "")) ci += c;
        return palette[ci % palette.Length];
    }

    string Initials(string name) {
        var p = (name ?? "?").Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return p.Length >= 2
            ? $"{char.ToUpper(p[0][0])}{char.ToUpper(p[^1][0])}"
            : (name ?? "?").Length > 0 ? char.ToUpper((name ?? "?")[0]).ToString() : "?";
    }

    // Main employee photo helpers
    var empName     = Model.Employee.FullName;
    var empBg       = AvatarBg(empName);
    var empInitials = Initials(empName);
    var hasPhoto    = !string.IsNullOrWhiteSpace(Model.Employee.ProfilePicturePath);
    var photoSrc    = hasPhoto ? Url.Content(Model.Employee.ProfilePicturePath) : null;
}

@section Styles {
    <link rel="stylesheet" href="~/css/Hierarchy.css" />
}

<div class="hierarchy-page">

    <ol class="hr-breadcrumb">
        <li><a asp-action="Index">Hierarchy</a></li>
        <li class="active">@Model.Employee.FullName</li>
    </ol>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible" role="alert">
            <i class="fas fa-exclamation-circle"></i>
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
    }

    <div class="hr-profile-card">
        @if (hasPhoto)
        {
            <div class="av av-xl av-rounded av-photo">
                <img src="@photoSrc"
                     alt="@empName"
                     class="av-img"
                     onerror="this.closest('.av-photo').classList.remove('av-photo'); this.closest('.av').style.background='@empBg'; this.closest('.av').textContent='@empInitials'; this.remove();" />
            </div>
        }
        else
        {
            <div class="av av-xl av-rounded"
                 style="background: @empBg">
                @empInitials
            </div>
        }

        <div class="hr-profile-info">
            <h3 class="hr-profile-name">@Model.Employee.FullName</h3>
            <p class="hr-profile-role">
                @Model.Employee.PositionTitle
                <span style="color: var(--hr-text-muted); font-weight: 400; margin: 0 4px;">in</span>
                @Model.Employee.DepartmentName
            </p>

            @if (Model.Info.IsTopLevel)
            {
                <span class="hr-badge-toplevel">
                    <i class="fas fa-crown" style="font-size:11px; margin-right:4px;"></i>
                    Top Level Manager
                </span>
            }

            <div class="hr-divider"></div>

            <div class="hr-meta-grid">
                <div class="hr-meta-item">
                    <span class="hr-meta-label">Email</span>
                    <span class="hr-meta-value">
                        <i class="fas fa-envelope"></i>
                        @Model.Employee.Email
                    </span>
                </div>
                @if (Model.Employee.HasPhoneNumber)
                {
                    <div class="hr-meta-item">
                        <span class="hr-meta-label">Phone</span>
                        <span class="hr-meta-value">
                            <i class="fas fa-phone"></i>
                            @Model.Employee.PhoneNumber
                        </span>
                    </div>
                }
                <div class="hr-meta-item">
                    <span class="hr-meta-label">Direct Reports</span>
                    <span class="hr-meta-value">
                        <i class="fas fa-users"></i>
                        @Model.Info.DirectReports
                    </span>
                </div>
                <div class="hr-meta-item">
                    <span class="hr-meta-label">Total Subordinates</span>
                    <span class="hr-meta-value">
                        <i class="fas fa-sitemap"></i>
                        @Model.Info.TotalSubordinates
                    </span>
                </div>
            </div>
        </div>
    </div>

    @if (Model.ManagerChain != null && Model.ManagerChain.Count > 1)
    {
        <div class="hr-section-card">
            <div class="hr-section-header">
                <i class="fas fa-users-cog"></i>
                Reporting Chain
            </div>
            <div class="hr-section-body">
                <div class="hr-chain-wrap">
                    @for (int i = 0; i < Model.ManagerChain.Count; i++)
                    {
                        var person      = Model.ManagerChain[i];
                        var pHasPhoto   = !string.IsNullOrWhiteSpace(person.ProfilePicturePath);
                        var pPhotoSrc   = pHasPhoto ? Url.Content(person.ProfilePicturePath) : null;
                        var pBg         = AvatarBg(person.FullName);
                        var pInitials   = Initials(person.FullName);

                        <a asp-action="Employee" asp-route-id="@person.Id" class="hr-chain-link">
                            <div class="hr-chain-person">
                                @if (pHasPhoto)
                                {
                                    <div class="av av-rounded av-photo">
                                        <img src="@pPhotoSrc"
                                             alt="@person.FullName"
                                             class="av-img"
                                             onerror="this.closest('.av-photo').classList.remove('av-photo'); this.closest('.av').style.background='@pBg'; this.closest('.av').textContent='@pInitials'; this.remove();" />
                                    </div>
                                }
                                else
                                {
                                    <div class="av av-rounded"
                                         style="background: @pBg">
                                        @pInitials
                                    </div>
                                }
                                <span class="hr-chain-name">@person.FullName</span>
                                <span class="hr-chain-title">@person.PositionTitle</span>
                            </div>
                        </a>
                        @if (i < Model.ManagerChain.Count - 1)
                        {
                            <span class="hr-chain-arrow"><i class="fas fa-arrow-right"></i></span>
                        }
                    }
                </div>
            </div>
        </div>
    }

    @if (Model.Info.HasSubordinates && Model.DirectReports != null && Model.DirectReports.Any())
    {
        <div class="hr-section-card">
            <div class="hr-section-header">
                <i class="fas fa-user-friends"></i>
                Direct Reports
                <span style="margin-left:auto; font-size:13px; font-weight:500; color:var(--hr-text-muted);">
                    @Model.Info.DirectReports total
                </span>
            </div>
            <div class="hr-section-body">
                <div class="hr-reports-grid">
                    @foreach (var subordinate in Model.DirectReports)
                    {
                        var sHasPhoto   = !string.IsNullOrWhiteSpace(subordinate.ProfilePicturePath);
                        var sPhotoSrc   = sHasPhoto ? Url.Content(subordinate.ProfilePicturePath) : null;
                        var sBg         = AvatarBg(subordinate.FullName);
                        var sInitials   = Initials(subordinate.FullName);

                        <a asp-action="Employee"
                           asp-route-id="@subordinate.Id"
                           class="hr-report-card">
                            @if (sHasPhoto)
                            {
                                <div class="av av-rounded av-photo">
                                    <img src="@sPhotoSrc"
                                         alt="@subordinate.FullName"
                                         class="av-img"
                                         onerror="this.closest('.av-photo').classList.remove('av-photo'); this.closest('.av').style.background='@sBg'; this.closest('.av').textContent='@sInitials'; this.remove();" />
                                </div>
                            }
                            else
                            {
                                <div class="av av-rounded"
                                     style="background: @sBg">
                                    @sInitials
                                </div>
                            }
                            <div>
                                <span class="hr-report-name">@subordinate.FullName</span>
                                <span class="hr-report-sub-text">
                                    @subordinate.PositionTitle &mdash; @subordinate.DepartmentName
                                </span>
                                @if (subordinate.HasSubordinates)
                                {
                                    <span class="hr-sub-badge">
                                        <i class="fas fa-users" style="font-size:10px;"></i>
                                        @subordinate.SubordinateCount subordinates
                                    </span>
                                }
                            </div>
                        </a>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            This employee has no direct reports.
        </div>
    }
</div>
