@* Views/Hierarchy/Index.cshtml *@
@model ERMS.ViewModels.Hierarchy.HierarchyIndexViewModel

@{
    ViewData["Title"] = "Organization Hierarchy";
}

@section Styles {
    <link rel="stylesheet" href="~/css/Hierarchy.css" />
}

<div class="hierarchy-page">

    <div class="page-header">
        <div class="header-content">
            <div class="header-text">
                <h1 class="page-title">
                    <i class="fas fa-sitemap"></i>
                    Organization Structure
                </h1>
                <p class="page-subtitle">Explore reporting relationships and team structure</p>
            </div>
            <div class="header-actions">
                <a asp-action="OrgChart" class="btn-primary">
                    <i class="fas fa-chart-bar"></i>
                    Org Chart View
                </a>
            </div>
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible" role="alert">
            <i class="fas fa-exclamation-circle"></i>
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
    }

    @if (Model.Statistics != null)
    {
        <div class="stats-grid">
            <div class="stat-card stat-primary">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                    <div class="stat-value">@Model.Statistics.TotalEmployees</div>
                    <div class="stat-label">Total Employees</div>
                </div>
            </div>
            <div class="stat-card stat-success">
                <div class="stat-icon"><i class="fas fa-crown"></i></div>
                <div class="stat-content">
                    <div class="stat-value">@Model.Statistics.TopLevelManagers</div>
                    <div class="stat-label">Executives</div>
                </div>
            </div>
            <div class="stat-card stat-info">
                <div class="stat-icon"><i class="fas fa-briefcase"></i></div>
                <div class="stat-content">
                    <div class="stat-value">@Model.Statistics.ManagersCount</div>
                    <div class="stat-label">Managers</div>
                </div>
            </div>
            <div class="stat-card stat-warning">
                <div class="stat-icon"><i class="fas fa-layer-group"></i></div>
                <div class="stat-content">
                    <div class="stat-value">@Model.Statistics.MaxHierarchyDepth</div>
                    <div class="stat-label">Levels Deep</div>
                </div>
            </div>
            <div class="stat-card stat-accent">
                <div class="stat-icon"><i class="fas fa-project-diagram"></i></div>
                <div class="stat-content">
                    <div class="stat-value">@Model.Statistics.AverageSpanOfControl</div>
                    <div class="stat-label">Avg Team Size</div>
                </div>
            </div>
        </div>
    }

    <div class="hierarchy-controls">
        <div class="control-section">
            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text"
                       id="hierarchySearch"
                       class="search-input"
                       placeholder="Search by name, position, or department…" />
            </div>
        </div>
        <div class="control-section">
            <div class="view-options">
                <button class="view-btn active" data-view="expanded">
                    <i class="fas fa-expand-alt"></i> Expand All
                </button>
                <button class="view-btn" data-view="collapsed">
                    <i class="fas fa-compress-alt"></i> Collapse All
                </button>
            </div>
        </div>
    </div>

    <div class="hierarchy-section">
        @if (Model.Hierarchy != null && Model.Hierarchy.Any())
        {
            <div class="hierarchy-tree">
                @foreach (var employee in Model.Hierarchy)
                {
                    @await Html.PartialAsync("_HierarchyNode", employee)
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-inbox"></i></div>
                <h3 class="empty-title">No Hierarchy Data</h3>
                <p class="empty-description">
                    The organizational structure hasn't been configured yet.
                    Please contact your administrator to set up the hierarchy.
                </p>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function () {

    // ── 1. Mark body ready — reveals tree (prevents blink) ──────────────
    // The CSS hides .hierarchy-tree until .hr-ready is on <body>.
    // We set state FIRST (all nodes already hr-expanded from server),
    // THEN reveal — so user never sees a collapse/re-expand flash.
    document.body.classList.add('hr-ready');

    // ── 2. Bootstrap tooltips ────────────────────────────────────────────
    if (typeof bootstrap !== 'undefined') {
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
            new bootstrap.Tooltip(el);
        });
    }

    // ── 3. Expand / Collapse buttons ─────────────────────────────────────
    function setAllNodes(expand) {
        document.querySelectorAll('.subordinates-grid').forEach(function (grid) {
            grid.classList.toggle('hr-expanded', expand);
        });
        document.querySelectorAll('.expand-btn').forEach(function (btn) {
            btn.setAttribute('aria-expanded', expand ? 'true' : 'false');
        });
    }

    document.querySelectorAll('.view-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            document.querySelectorAll('.view-btn').forEach(function (b) {
                b.classList.remove('active');
            });
            this.classList.add('active');
            setAllNodes(this.dataset.view === 'expanded');
        });
    });

    // ── 4. Per-node expand button ────────────────────────────────────────
    document.querySelectorAll('.expand-btn').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
            e.stopPropagation();
            var targetId = this.dataset.target;
            var grid = document.getElementById(targetId);
            if (!grid) return;
            var isOpen = grid.classList.toggle('hr-expanded');
            this.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });
    });

    // ── 5. Search ────────────────────────────────────────────────────────
    var searchTimeout;
    document.getElementById('hierarchySearch').addEventListener('input', function () {
        clearTimeout(searchTimeout);
        var term = this.value.toLowerCase().trim();

        searchTimeout = setTimeout(function () {
            var nodes = document.querySelectorAll('.org-chart-node');

            if (!term) {
                nodes.forEach(function (node) {
                    node.style.display = '';
                    node.classList.remove('search-highlight');
                });
                return;
            }

            nodes.forEach(function (node) {
                var name   = node.querySelector('.node-name')?.textContent ?? '';
                var title  = node.querySelector('.node-title')?.textContent ?? '';
                var dept   = node.querySelector('.node-department')?.textContent ?? '';
                var match  = (name + title + dept).toLowerCase().includes(term);

                node.style.display = match ? '' : 'none';
                node.classList.toggle('search-highlight', match);

                // Keep all ancestors visible
                if (match) {
                    var ancestor = node.parentElement;
                    while (ancestor) {
                        if (ancestor.classList.contains('org-chart-node')) {
                            ancestor.style.display = '';
                            var grid = ancestor.querySelector(':scope > .subordinates-grid');
                            if (grid) grid.classList.add('hr-expanded');
                        }
                        ancestor = ancestor.parentElement;
                    }
                }
            });
        }, 250);
    });

    // ── 6. Print shortcut ────────────────────────────────────────────────
    document.addEventListener('keydown', function (e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            window.print();
        }
    });
});
</script>
}
