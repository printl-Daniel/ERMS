@* Views/Hierarchy/OrgChart.cshtml *@
@model ERMS.ViewModels.Hierarchy.OrgChartViewModel

@{
    ViewData["Title"] = "Organization Chart";
}

<div class="container-fluid">
    <div class="row" style="margin-bottom: 20px;">
        <div class="col-md-12">
            <div class="clearfix">
                <div class="pull-left">
                    <h2><i class="fa fa-project-diagram"></i> @Model.Title</h2>
                    <p class="text-muted">Interactive organizational chart (@Model.TotalNodes employees)</p>
                </div>
                <div class="pull-right" style="margin-top: 20px;">
                    <a asp-action="Index" class="btn btn-default">
                        <i class="fa fa-list"></i> List View
                    </a>
                </div>
            </div>
        </div>
    </div>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible" role="alert">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            @TempData["Error"]
        </div>
    }

    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div id="orgChart" style="min-height: 600px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        const orgData = @Html.Raw(Json.Serialize(Model.ChartData));

        // Create org chart visualization
        function createOrgChart(data) {
            if (!data || data.length === 0) {
                document.getElementById('orgChart').innerHTML = '<div class="alert alert-info">No data available for org chart.</div>';
                return;
            }

            const width = document.getElementById('orgChart').offsetWidth;
            const height = 600;

            const svg = d3.select('#orgChart')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            const g = svg.append('g')
                .attr('transform', 'translate(40,40)');

            // Create tree layout
            const tree = d3.tree()
                .size([height - 80, width - 160]);

            // Convert flat data to hierarchy
            const root = d3.hierarchy(data[0], d => d.children);
            tree(root);

            // Draw links
            g.selectAll('.link')
                .data(root.links())
                .enter()
                .append('path')
                .attr('class', 'link')
                .attr('d', d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x))
                .style('fill', 'none')
                .style('stroke', '#ccc')
                .style('stroke-width', 2);

            // Draw nodes
            const node = g.selectAll('.node')
                .data(root.descendants())
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.y},${d.x})`)
                .style('cursor', 'pointer')
                .on('click', function(event, d) {
                    window.location.href = '/Hierarchy/Employee/' + d.data.id;
                });

            // Add rectangles for nodes
            node.append('rect')
                .attr('width', 180)
                .attr('height', 80)
                .attr('x', -90)
                .attr('y', -40)
                .style('fill', '#fff')
                .style('stroke', '#337ab7')
                .style('stroke-width', 2)
                .style('rx', 5);

            // Add text
            node.append('text')
                .attr('dy', -15)
                .attr('text-anchor', 'middle')
                .text(d => d.data.name)
                .style('font-weight', 'bold')
                .style('font-size', '12px');

            node.append('text')
                .attr('dy', 5)
                .attr('text-anchor', 'middle')
                .text(d => d.data.title || '')
                .style('font-size', '10px')
                .style('fill', '#666');

            node.append('text')
                .attr('dy', 20)
                .attr('text-anchor', 'middle')
                .text(d => d.data.department || '')
                .style('font-size', '9px')
                .style('fill', '#999');
        }

        // Initialize chart when page loads
        if (orgData && orgData.length > 0) {
            createOrgChart(orgData);
        } else {
            document.getElementById('orgChart').innerHTML = '<div class="alert alert-info">No organization chart data available.</div>';
        }
    </script>
}

@section Styles {
    <style>
        #orgChart {
            overflow: auto;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .node {
            cursor: pointer;
        }

            .node:hover rect {
                fill: #e7f3ff;
            }
    </style>
}